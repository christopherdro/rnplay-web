#!/usr/bin/env ruby
#
require 'json'

name = Dir.pwd.split("/").last.split(".").first
target = "/rails/app_js/#{name}"

def npm_install(target)
  json = JSON.parse(File.read("#{target}/package.json"))
  json['dependencies'].delete('react-native')
  File.open("#{target}/package.json", "w") {|f| f.write(JSON.pretty_generate(json))}
  puts `cd #{target} && npm install`
end

if File.exists?(target)
  puts `git --work-tree #{target} --git-dir #{target}/.git fetch origin && git --work-tree #{target} --git-dir #{target}/.git reset --hard origin/master && chown -R 9999:9999 #{target}`
  npm_install(target)
else
  puts `git clone /var/repos/#{name}.git /rails/app_js/#{name} & chown -R 9999:9999 #{target}`
  npm_install(target)
end
